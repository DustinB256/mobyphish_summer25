<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ShopWise Store</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
      }
      body {
        background: linear-gradient(45deg, #ff6b6b, #feca57);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        color: #2c2c2c;
      }
      header {
        background: #ff4757;
        color: #fff;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      }
      main {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 30px;
      }
      .card {
        background: #fff;
        padding: 35px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 420px;
        text-align: center;
        border: 2px solid #feca57;
      }
      input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        margin-top: 8px;
        font-size: 14px;
      }
      input:focus {
        border-color: #ff4757;
        outline: none;
      }
      button {
        margin-top: 20px;
        padding: 12px 25px;
        background: #ff4757;
        color: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
      }
      button:hover {
        background: #ff3742;
      }
      .error {
        color: #c44569;
        font-size: 0.9rem;
        margin-top: 10px;
      }
      #reportBtn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #c44569;
        color: #fff;
        border: none;
        border-radius: 50px;
        padding: 12px 18px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }
      #reportBtn:hover {
        background: #a53860;
      }
    </style>
  </head>
  <body>
    <header><h1>üõçÔ∏è ShopWise Store</h1></header>

    <main>
      <!-- Login -->
      <div id="loginCard" class="card">
        <h2>Customer Login</h2>
        <input id="acc" placeholder="Customer ID" />
        <input id="pwd" type="password" placeholder="Password" />
        <button id="loginBtn">Sign In</button>
        <div id="loginErr" class="error"></div>
      </div>

      <!-- Task -->
      <div id="taskCard" class="card" style="display: none">
        <h2>Order Confirmation</h2>
        <p style="margin: 18px 0">
          Confirm purchase of <strong>Wireless Headphones</strong> for <strong>$89.99</strong>
        </p>
        <button id="approveBtn">Confirm Order</button>
      </div>

      <!-- Success -->
      <div id="doneCard" class="card" style="display: none">
        <h2>Order Confirmed ‚úÖ</h2>
        <p>Task complete. Please close this tab and open your email for the next task.</p>
      </div>
    </main>

    <button id="reportBtn">üö® Report Phish</button>

    <script>
      (() => {
        /*  <<< customise for each site  >>>  */
        const siteUrl = "shopwise.local";
        const siteName = "ShopWise Store";
        /* ---------------------------------- */

        const validAccount = "test",
          validPassword = "test";
        const userId = Number(localStorage.getItem("study_uid") || 123);

        const pageStart = Date.now();
        const $ = (id) => document.getElementById(id);

        const log = (msg) =>
          fetch("http://localhost:5001/log", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: userId, text: msg }),
          }).catch(() => {});

        /* mark login */
        const markLogin = () =>
          fetch("http://localhost:5001/login-event", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: userId, site_url: siteUrl }),
          }).catch(() => {});

        /* finish + queue next */
        function finishTask(type) {
          fetch("http://localhost:5001/complete-task", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              user_id: userId,
              site_url: siteUrl,
              elapsed_ms: Date.now() - pageStart,
              completion_type: type,
            }),
          })
            .then((r) => r.json())
            .then((j) => {
              if (j.error === "no_pending_assignment") {
                alert("Please complete the latest task sent to you via email.");
              }
            })
            .catch(() => {});
        }

        /* ----- DOM refs ----- */
        const loginCard = $("loginCard"),
          taskCard = $("taskCard"),
          doneCard = $("doneCard");

        /* login click */
        $("loginBtn").onclick = () => {
          if (
            $("acc").value.trim() === validAccount &&
            $("pwd").value.trim() === validPassword
          ) {
            $("loginErr").textContent = "";
            loginCard.style.display = "none";
            taskCard.style.display = "block";
            log(
              `User ${userId} logged into ${siteName} at ${new Date().toISOString()}`
            );
            markLogin();
          } else $("loginErr").textContent = "Invalid credentials.";
        };

        /* approve */
        $("approveBtn").onclick = () => {
          taskCard.style.display = "none";
          doneCard.style.display = "block";
          finishTask("task_completed");
        };

        /* report */
        $("reportBtn").onclick = () => {
          if (!confirm("Report this site as phishing?")) return;
          log(
            `User ${userId} reported ${siteName} as phishing at ${new Date().toISOString()}`
          );
          finishTask("reported_phishing");
          alert("Thank you. Return to your email for the next task.");
          location.reload();
        };
      })();
    </script>
  </body>
</html>