<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Money Transfer Admin Portal</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
      }
      body {
        background: #f0f8ff;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        color: #2c3e50;
      }
      header {
        background: #2980b9;
        color: #fff;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      main {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 30px;
      }
      .card {
        background: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 400px;
        text-align: center;
        border-top: 4px solid #27ae60;
      }
      input {
        width: 100%;
        padding: 10px;
        border: 1px solid #bdc3c7;
        border-radius: 5px;
        margin-top: 8px;
        font-size: 14px;
      }
      button {
        margin-top: 20px;
        padding: 12px 20px;
        background: #27ae60;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
      }
      button:hover {
        background: #219a52;
      }
      .error {
        color: #e67e22;
        font-size: 0.9rem;
        margin-top: 10px;
      }
      #reportBtn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #e74c3c;
        color: #fff;
        border: none;
        border-radius: 50px;
        padding: 12px 18px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }
      #reportBtn:hover {
        background: #c0392b;
      }
    </style>
  </head>
  <body>
    <header><h1>‚öïÔ∏è Money Transfer</h1></header>

    <main>
      <!-- Login -->
      <div id="loginCard" class="card">
        <h2>Login Portal</h2>
        <input id="acc" placeholder="User ID" />
        <input id="pwd" type="password" placeholder="Password" />
        <button id="loginBtn">Login</button>
        <div id="loginErr" class="error"></div>
      </div>

      <!-- Task -->
      <div id="taskCard" class="card" style="display: none">
        <h2>Money Transfer</h2>
        <p style="margin: 18px 0">
          Approve Money transfer for <strong>$185.00</strong>
        </p>
        <button id="approveBtn">Approve Transfer</button>
      </div>

      <!-- Success -->
      <div id="doneCard" class="card" style="display: none">
        <h2>Transfer Approved ‚úÖ</h2>
        <p>Task complete. Please close this tab and open your email for the next task.</p>
      </div>
    </main>

    <button id="reportBtn">üö® Report Phish</button>

    <script>
      (() => {
        /*  <<< customise for each site  >>>  */
        const siteUrl = "healthplus.local";
        const siteName = "HealthPlus Portal";
        /* ---------------------------------- */

        const validAccount = "test",
          validPassword = "test";
        const userId = Number(localStorage.getItem("study_uid") || 123);

        const pageStart = Date.now();
        const $ = (id) => document.getElementById(id);

        const log = (msg) =>
          fetch("http://localhost:5001/log", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: userId, text: msg }),
          }).catch(() => {});

        /* mark login */
        const markLogin = () =>
          fetch("http://localhost:5001/login-event", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: userId, site_url: siteUrl }),
          }).catch(() => {});

        /* finish + queue next */
        function finishTask(type) {
          fetch("http://localhost:5001/complete-task", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              user_id: userId,
              site_url: siteUrl,
              elapsed_ms: Date.now() - pageStart,
              completion_type: type,
            }),
          })
            .then((r) => r.json())
            .then((j) => {
              if (j.error === "no_pending_assignment") {
                alert("Please complete the latest task sent to you via email.");
              }
            })
            .catch(() => {});
        }

        /* ----- DOM refs ----- */
        const loginCard = $("loginCard"),
          taskCard = $("taskCard"),
          doneCard = $("doneCard");

        /* login click */
        $("loginBtn").onclick = () => {
          if (
            $("acc").value.trim() === validAccount &&
            $("pwd").value.trim() === validPassword
          ) {
            $("loginErr").textContent = "";
            loginCard.style.display = "none";
            taskCard.style.display = "block";
            log(
              `User ${userId} logged into ${siteName} at ${new Date().toISOString()}`
            );
            markLogin();
          } else $("loginErr").textContent = "Invalid credentials.";
        };

        /* approve */
        $("approveBtn").onclick = () => {
          taskCard.style.display = "none";
          doneCard.style.display = "block";
          finishTask("task_completed");
        };

        /* report */
        $("reportBtn").onclick = () => {
          if (!confirm("Report this site as phishing?")) return;
          log(
            `User ${userId} reported ${siteName} as phishing at ${new Date().toISOString()}`
          );
          finishTask("reported_phishing");
          alert("Thank you. Return to your email for the next task.");
          location.reload();
        };
      })();
    </script>
  </body>
</html>